# NMS Docker Compose Configuration
# Version: 2.0.0
# Updated: December 7, 2025
# Production Ready Enterprise Network Management System

services:
  # MongoDB Database
  mongodb:
    image: mongo:7-jammy
    container_name: nms-mongodb
    restart: unless-stopped
    env_file:
      - .env
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: nms_db
    volumes:
      - mongodb_data:/data/db
      - ./mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
    ports:
      - "0.0.0.0:${MONGO_PORT}:${MONGO_PORT}"
    networks:
      - nms-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh ${IP}:${MONGO_PORT}/test --quiet
      interval: 30s
      timeout: 10s
      retries: 5

  # Backend API
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: nms-backend
    restart: unless-stopped
    env_file:
      - .env
    environment:
      NODE_ENV: production
      PORT: ${BACKEND_PORT}
      IP: ${IP}
      MONGODB_URI: mongodb://${MONGO_ROOT_USER}:${MONGO_ROOT_PASSWORD}@mongodb:${MONGO_PORT:-27017}/nms_db?authSource=admin
      JWT_SECRET: ${JWT_SECRET:-please-set-JWT_SECRET-environment-variable-for-security}
      JWT_EXPIRES_IN: 24h
      CREATE_ADMIN_USER: "true"
      ADMIN_USERNAME: ${ADMIN_USERNAME:-admin}
      ADMIN_EMAIL: ${ADMIN_EMAIL}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
      FRONTEND_URL: http://${IP}:${FRONTEND_PORT}
      ALLOW_ALL_ORIGINS: ${ALLOW_ALL_ORIGINS:-false}
      HOST_NETWORK_RANGE: ${IP}/24
      PRODUCTION_MODE: true
      EXCLUDE_DOCKER_NETWORKS: true
      DOCKER_HOST_GATEWAY: host.docker.internal
      # SMTP Configuration for email verification
      SMTP_HOST: ${SMTP_HOST:-smtp.gmail.com}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_SECURE: ${SMTP_SECURE:-false}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      SMTP_FROM: ${SMTP_FROM:-}
    ports:
      - "0.0.0.0:${BACKEND_PORT}:${BACKEND_PORT}"
    networks:
      - nms-network
    # Enable access to host network for device scanning
    extra_hosts:
      - "host.docker.internal:host-gateway"
    # Add NET_RAW capability for ping operations
    cap_add:
      - NET_RAW
    depends_on:
      mongodb:
        condition: service_healthy
    volumes:
      - ./backend/logs:/usr/src/app/logs
    healthcheck:
      test: ["CMD", "node", "-e", "const http = require('http'); const options = { hostname: process.env.IP, port: process.env.BACKEND_PORT, path: '/api/health', timeout: 3000 }; const req = http.request(options, (res) => { if (res.statusCode === 200) process.exit(0); else process.exit(1); }); req.on('error', () => process.exit(1)); req.end();"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        REACT_APP_BACKEND_PORT: ${BACKEND_PORT}
        REACT_APP_ENV: development
    container_name: nms-frontend
    restart: unless-stopped
    env_file:
      - .env
    environment:
      BACKEND_HOST: backend
      BACKEND_PORT: ${BACKEND_PORT}
      FRONTEND_PORT: 80
      SERVER_IP: ${IP}
      IP: ${IP}  # Legacy support
    ports:
      - "0.0.0.0:${FRONTEND_PORT}:${FRONTEND_INTERNAL_PORT:-80}"
    networks:
      - nms-network
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://${IP}:${FRONTEND_PORT}/health"]
      interval: 30s
      timeout: 10s
      retries: 5

volumes:
  mongodb_data:
    driver: local

networks:
  nms-network:
    driver: bridge